<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DChat - Decentralized Discord Clone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.36/dist/web3.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .channel:hover {
            background-color: #2f3136;
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.7);
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2e3338;
        }
        ::-webkit-scrollbar-thumb {
            background: #202225;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #36393f;
        }
        .message:hover {
            background-color: #32353b;
        }
        .channel-active {
            background-color: #393c43;
        }
        .avatars-holder {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Landing Page -->
    <div id="landing" class="min-h-screen flex flex-col">
        <nav class="bg-[#2f3136] p-4 shadow-lg">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <i class="bi bi-discord text-[#5865F2] text-3xl"></i>
                    <h1 class="text-2xl font-bold">DChat</h1>
                </div>
                <div class="flex gap-4 items-center">
                    <span id="networkStatus" class="text-gray-400 text-sm hidden md:inline-block"></span>
                    <button onclick="connectWallet()" id="connectBtn" class="bg-[#5865F2] px-4 py-2 rounded-md hover:bg-[#4752C4] transition flex items-center gap-2">
                        <i class="bi bi-wallet2"></i> Connect Wallet
                    </button>
                </div>
            </div>
        </nav>

        <main class="flex-grow container mx-auto px-4 py-16 flex flex-col md:flex-row items-center justify-between">
            <div class="text-center md:text-left md:max-w-xl">
                <h2 class="text-4xl md:text-5xl lg:text-6xl font-bold mb-6">Decentralized Communication</h2>
                <p class="text-xl mb-8 text-gray-300">Join the future of secure, blockchain-powered messaging. Create channels, chat with friends, and make voice calls - all secured by Ethereum.</p>
                <button onclick="showApp()" class="bg-[#5865F2] px-8 py-4 rounded-lg text-lg font-semibold hover:bg-[#4752C4] transition flex items-center gap-2 mx-auto md:mx-0">
                    <i class="bi bi-rocket-takeoff"></i> Launch App
                </button>
            </div>
            <div class="mt-10 md:mt-0">
                <img src="https://images.unsplash.com/photo-1639762681057-408e52192e55?q=80&w=2232&auto=format&fit=crop" alt="Blockchain Illustration" class="w-full max-w-md rounded-lg shadow-2xl">
            </div>
        </main>

        <footer class="bg-[#202225] p-6 mt-auto">
            <div class="container mx-auto text-center text-gray-400">
                <p>DChat - Powered by Ethereum. Made with ❤️ for decentralized communities.</p>
            </div>
        </footer>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden min-h-screen flex flex-col md:flex-row">
        <!-- Servers Sidebar -->
        <div class="w-full md:w-20 bg-[#202225] p-3 flex md:flex-col items-center gap-4 md:h-screen overflow-x-auto md:overflow-y-auto">
            <div class="w-12 h-12 bg-[#5865F2] rounded-full flex items-center justify-center cursor-pointer hover:rounded-2xl transition-all duration-200">
                <i class="bi bi-house-door-fill text-2xl"></i>
            </div>
            <div class="w-12 h-12 bg-[#36393f] rounded-full flex items-center justify-center cursor-pointer hover:rounded-2xl transition-all duration-200">
                <i class="bi bi-chat-dots-fill text-2xl text-[#5865F2]"></i>
            </div>
            <div class="w-12 h-12 bg-[#36393f] rounded-full flex items-center justify-center cursor-pointer hover:rounded-2xl transition-all duration-200">
                <i class="bi bi-people-fill text-2xl text-green-500"></i>
            </div>
            <div class="w-12 h-12 bg-[#36393f] rounded-full flex items-center justify-center cursor-pointer hover:rounded-2xl transition-all duration-200">
                <i class="bi bi-graph-up text-2xl text-purple-500"></i>
            </div>
            <div class="hidden md:flex w-12 h-12 bg-[#36393f] rounded-full items-center justify-center cursor-pointer hover:rounded-2xl transition-all duration-200 mt-auto">
                <i class="bi bi-gear-fill text-2xl text-gray-400"></i>
            </div>
        </div>

        <!-- Channels Sidebar -->
        <div class="hidden md:block w-64 bg-[#2f3136] flex flex-col h-screen">
            <div class="p-4 border-b border-gray-900 flex justify-between items-center">
                <h2 class="font-bold">DChat Server</h2>
                <button class="text-gray-400 hover:text-white">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
            </div>
            
            <div class="p-4 overflow-y-auto flex-grow">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xs text-gray-400 font-semibold uppercase tracking-wider">Text Channels</h3>
                    <button onclick="showCreateChannelModal('text')" class="text-gray-400 hover:text-white text-lg">
                        <i class="bi bi-plus-circle"></i>
                    </button>
                </div>
                <div id="textChannelList" class="mb-6">
                    <!-- Text Channels will be added here -->
                    <div class="channel flex items-center gap-2 p-2 rounded cursor-pointer mb-1" onclick="loadChannel('general', 'text')">
                        <i class="bi bi-hash text-gray-400"></i>
                        <span>general</span>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xs text-gray-400 font-semibold uppercase tracking-wider">Voice Channels</h3>
                    <button onclick="showCreateChannelModal('voice')" class="text-gray-400 hover:text-white text-lg">
                        <i class="bi bi-plus-circle"></i>
                    </button>
                </div>
                <div id="voiceChannelList">
                    <!-- Voice Channels will be added here -->
                    <div class="channel flex items-center gap-2 p-2 rounded cursor-pointer mb-1" onclick="loadChannel('General Voice', 'voice')">
                        <i class="bi bi-broadcast text-gray-400"></i>
                        <span>General Voice</span>
                    </div>
                </div>
            </div>
            
            <div class="p-3 bg-[#292b2f] flex items-center gap-3">
                <div class="w-9 h-9 rounded-full bg-green-500 flex items-center justify-center">
                    <i class="bi bi-person-fill text-lg"></i>
                </div>
                <div class="flex-grow">
                    <div id="userWalletDisplay" class="text-sm font-medium truncate">User</div>
                    <div class="text-xs text-green-500">Online</div>
                </div>
                <div class="flex gap-2">
                    <button class="text-gray-400 hover:text-white">
                        <i class="bi bi-mic-fill"></i>
                    </button>
                    <button class="text-gray-400 hover:text-white">
                        <i class="bi bi-gear-fill"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Header and Navigation -->
        <div class="md:hidden w-full bg-[#36393f] p-4 flex justify-between items-center border-b border-gray-800">
            <button id="mobileNavToggle" class="text-white">
                <i class="bi bi-list text-2xl"></i>
            </button>
            <h2 class="font-bold">DChat</h2>
            <button id="mobileUserButton" class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center">
                <i class="bi bi-person-fill"></i>
            </button>
        </div>

        <!-- Mobile Navigation Menu -->
        <div id="mobileNavMenu" class="hidden md:hidden w-full bg-[#2f3136] absolute top-16 left-0 z-10 p-4 border-b border-gray-800">
            <div class="mb-4">
                <h3 class="text-xs text-gray-400 font-semibold uppercase tracking-wider mb-2">Text Channels</h3>
                <div id="mobileTextChannelList">
                    <!-- Mobile Text Channels will be added here -->
                    <div class="channel flex items-center gap-2 p-2 rounded cursor-pointer mb-1" onclick="loadChannel('general', 'text'); toggleMobileNav();">
                        <i class="bi bi-hash text-gray-400"></i>
                        <span>general</span>
                    </div>
                </div>
                <button onclick="showCreateChannelModal('text')" class="text-gray-400 hover:text-white flex items-center gap-2 mt-2">
                    <i class="bi bi-plus-circle"></i> New Text Channel
                </button>
            </div>
            
            <div>
                <h3 class="text-xs text-gray-400 font-semibold uppercase tracking-wider mb-2">Voice Channels</h3>
                <div id="mobileVoiceChannelList">
                    <!-- Mobile Voice Channels will be added here -->
                    <div class="channel flex items-center gap-2 p-2 rounded cursor-pointer mb-1" onclick="loadChannel('General Voice', 'voice'); toggleMobileNav();">
                        <i class="bi bi-broadcast text-gray-400"></i>
                        <span>General Voice</span>
                    </div>
                </div>
                <button onclick="showCreateChannelModal('voice')" class="text-gray-400 hover:text-white flex items-center gap-2 mt-2">
                    <i class="bi bi-plus-circle"></i> New Voice Channel
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-grow bg-[#36393f] flex flex-col h-screen md:h-auto">
            <div id="channelHeader" class="border-b border-gray-800 p-4 hidden md:flex items-center">
                <i class="bi bi-hash text-gray-400 text-xl mr-2"></i>
                <h3 id="currentChannelName" class="font-bold">Select a channel</h3>
            </div>

            <div id="channelContent" class="flex-grow p-4 overflow-y-auto">
                <div class="h-full flex flex-col justify-center items-center">
                    <div class="w-16 h-16 rounded-full bg-[#5865F2] flex items-center justify-center mb-4">
                        <i class="bi bi-discord text-white text-4xl"></i>
                    </div>
                    <p class="text-lg font-bold">Welcome to DChat!</p>
                    <p class="text-gray-400 text-center mt-2 max-w-md">
                        Select a channel to start chatting or create a new one using your Ethereum wallet.
                    </p>
                </div>
            </div>

            <!-- Message Input -->
            <div id="messageInputContainer" class="p-4 hidden">
                <div class="bg-[#40444b] rounded-lg p-2">
                    <input id="messageInput" type="text" placeholder="Message #general" class="w-full bg-transparent outline-none" onkeydown="if(event.key === 'Enter') sendMessage()">
                </div>
            </div>
        </div>

        <!-- Active Users Sidebar -->
        <div class="hidden lg:block w-60 bg-[#2f3136] h-screen p-4 overflow-y-auto">
            <h3 class="text-xs text-gray-400 font-semibold uppercase tracking-wider mb-4">Online — 1</h3>
            <div class="flex items-center gap-3 p-2">
                <div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center">
                    <i class="bi bi-person-fill"></i>
                </div>
                <div id="sidebarUserDisplay" class="truncate">You</div>
            </div>
        </div>
    </div>

    <!-- Create Channel Modal -->
    <div id="createChannelModal" class="modal hidden fixed inset-0 flex items-center justify-center z-20">
        <div class="bg-[#36393f] p-6 rounded-lg w-96 max-w-[90%]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="modalTitle">Create New Channel</h3>
                <button onclick="hideCreateChannelModal()" class="text-gray-400 hover:text-white">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="mb-4">
                <label class="block mb-2 text-sm font-medium">Channel Name</label>
                <input type="text" id="channelName" class="w-full p-2 rounded bg-[#202225] border border-[#40444b] focus:border-[#5865F2] focus:outline-none" placeholder="new-channel">
            </div>
            <input type="hidden" id="channelTypeHidden" value="text">
            <div class="mb-4">
                <label class="block mb-2 text-sm font-medium">Transaction Cost</label>
                <div class="bg-[#202225] p-3 rounded border border-[#40444b] flex justify-between items-center">
                    <div>
                        <span class="text-gray-400">Estimated Gas:</span>
                        <span id="estimatedGas" class="ml-2">0.01 ETH</span>
                    </div>
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6f/Ethereum-icon-purple.svg/1200px-Ethereum-icon-purple.svg.png" alt="ETH" class="w-6 h-6">
                </div>
                <p class="text-xs text-gray-400 mt-1">* Uses Testnet ETH from your wallet</p>
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="hideCreateChannelModal()" class="px-4 py-2 rounded text-gray-400 hover:bg-[#2f3136]">Cancel</button>
                <button onclick="createChannel()" id="createChannelBtn" class="bg-[#5865F2] px-4 py-2 rounded hover:bg-[#4752C4] flex items-center gap-2">
                    <i class="bi bi-plus-lg"></i>
                    <span>Create Channel</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Voice Chat Modal -->
    <div id="voiceChatModal" class="modal hidden fixed inset-0 flex items-center justify-center z-20">
        <div class="bg-[#36393f] p-6 rounded-lg w-96 max-w-[90%]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="voiceChannelTitle">Voice Channel</h3>
                <button onclick="leaveVoiceChannel()" class="text-gray-400 hover:text-white">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="mb-6">
                <div class="bg-[#2f3136] rounded-lg p-4 flex flex-col gap-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center">
                            <i class="bi bi-person-fill text-lg"></i>
                        </div>
                        <div class="flex-grow">
                            <div id="voiceChatUser" class="font-medium">You</div>
                            <div class="text-xs text-green-500">Speaking</div>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="bi bi-reception-4 text-green-500"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-between gap-3">
                <button id="muteBtn" class="bg-[#4f545c] hover:bg-[#686d73] p-3 rounded-full">
                    <i class="bi bi-mic-fill text-lg"></i>
                </button>
                <button id="deafenBtn" class="bg-[#4f545c] hover:bg-[#686d73] p-3 rounded-full">
                    <i class="bi bi-headphones text-lg"></i>
                </button>
                <button id="settingsBtn" class="bg-[#4f545c] hover:bg-[#686d73] p-3 rounded-full">
                    <i class="bi bi-gear-fill text-lg"></i>
                </button>
                <button onclick="leaveVoiceChannel()" class="bg-[#ed4245] hover:bg-[#f04d50] p-3 rounded-full">
                    <i class="bi bi-telephone-x-fill text-lg"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Transaction Processing Modal -->
    <div id="transactionModal" class="modal hidden fixed inset-0 flex items-center justify-center z-30">
        <div class="bg-[#36393f] p-6 rounded-lg w-96 max-w-[90%] text-center">
            <div id="txPending">
                <div class="animate-spin mx-auto mb-6 w-16 h-16 border-4 border-[#5865F2] border-t-transparent rounded-full"></div>
                <h3 class="text-xl font-bold mb-2">Processing Transaction</h3>
                <p class="text-gray-400">Please wait while we process your transaction on the blockchain...</p>
            </div>
            <div id="txSuccess" class="hidden">
                <div class="mx-auto mb-6 w-16 h-16 bg-green-500 rounded-full flex items-center justify-center">
                    <i class="bi bi-check-lg text-4xl"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">Success!</h3>
                <p class="text-gray-400 mb-4">Your channel has been created successfully.</p>
                <button onclick="closeTransactionModal()" class="bg-[#5865F2] px-4 py-2 rounded hover:bg-[#4752C4]">Close</button>
            </div>
            <div id="txError" class="hidden">
                <div class="mx-auto mb-6 w-16 h-16 bg-red-500 rounded-full flex items-center justify-center">
                    <i class="bi bi-x-lg text-4xl"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">Transaction Failed</h3>
                <p id="txErrorMessage" class="text-gray-400 mb-4">There was an error processing your transaction.</p>
                <button onclick="closeTransactionModal()" class="bg-[#5865F2] px-4 py-2 rounded hover:bg-[#4752C4]">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let web3;
        let accounts = [];
        let currentAccount = null;
        let currentChannelType = null;
        let currentChannelName = null;
        let mediaStream = null;
        let connected = false;
        let messages = {
            'general': [
                { sender: 'System', content: 'Welcome to the general channel!', timestamp: new Date().toISOString() }
            ]
        };
        let voiceConnected = false;
        
        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('mobileNavToggle').addEventListener('click', toggleMobileNav);
            document.getElementById('mobileUserButton').addEventListener('click', showUserSettings);
            checkMetaMaskConnection();
        });

        function toggleMobileNav() {
            const mobileMenu = document.getElementById('mobileNavMenu');
            mobileMenu.classList.toggle('hidden');
        }

        function showUserSettings() {
            alert('User settings would show here');
        }

        // Check if MetaMask is already connected
        async function checkMetaMaskConnection() {
            if (typeof window.ethereum !== 'undefined') {
                web3 = new Web3(window.ethereum);
                try {
                    // Check if already connected
                    accounts = await web3.eth.getAccounts();
                    if (accounts.length > 0) {
                        currentAccount = accounts[0];
                        updateConnectedUI(currentAccount);
                        connected = true;
                        
                        // Check network
                        const networkId = await web3.eth.net.getId();
                        updateNetworkDisplay(networkId);
                    }
                } catch (error) {
                    console.error("Error checking connection:", error);
                }
            } else {
                console.log("Please install MetaMask!");
            }
        }

        // Connect to MetaMask
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask to use this application!');
                return;
            }

            try {
                document.getElementById('connectBtn').innerHTML = '<i class="bi bi-arrow-repeat animate-spin"></i> Connecting...';
                
                // Request account access
                web3 = new Web3(window.ethereum);
                accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                if (accounts.length > 0) {
                    currentAccount = accounts[0];
                    updateConnectedUI(currentAccount);
                    connected = true;
                    
                    // Check network
                    const networkId = await web3.eth.net.getId();
                    updateNetworkDisplay(networkId);
                    
                    // Listen for account changes
                    window.ethereum.on('accountsChanged', function (newAccounts) {
                        if (newAccounts.length > 0) {
                            currentAccount = newAccounts[0];
                            updateConnectedUI(currentAccount);
                        } else {
                            disconnectWallet();
                        }
                    });
                    
                    // Listen for network changes
                    window.ethereum.on('chainChanged', function(networkId) {
                        updateNetworkDisplay(parseInt(networkId));
                    });
                }
            } catch (error) {
                console.error("Error connecting to MetaMask:", error);
                document.getElementById('connectBtn').innerHTML = '<i class="bi bi-wallet2"></i> Connect Wallet';
                alert('Failed to connect to MetaMask. Please try again.');
            }
        }

        function disconnectWallet() {
            currentAccount = null;
            connected = false;
            document.getElementById('connectBtn').innerHTML = '<i class="bi bi-wallet2"></i> Connect Wallet';
            document.getElementById('userWalletDisplay').textContent = 'User';
            document.getElementById('sidebarUserDisplay').textContent = 'You';
            document.getElementById('networkStatus').textContent = '';
            document.getElementById('networkStatus').classList.add('hidden');
        }

        function updateConnectedUI(account) {
            const shortAccount = account.substring(0, 6) + '...' + account.substring(account.length - 4);
            document.getElementById('connectBtn').innerHTML = '<i class="bi bi-wallet2-fill"></i> ' + shortAccount;
            document.getElementById('userWalletDisplay').textContent = shortAccount;
            document.getElementById('sidebarUserDisplay').textContent = shortAccount;
            document.getElementById('voiceChatUser').textContent = shortAccount;
        }

        function updateNetworkDisplay(networkId) {
            let networkName;
            let networkClass;
            
            switch(networkId) {
                case 1:
                    networkName = 'Ethereum Mainnet';
                    networkClass = 'text-yellow-500';
                    break;
                case 3:
                    networkName = 'Ropsten Testnet';
                    networkClass = 'text-green-500';
                    break;
                case 4:
                    networkName = 'Rinkeby Testnet';
                    networkClass = 'text-green-500';
                    break;
                case 5:
                    networkName = 'Goerli Testnet';
                    networkClass = 'text-green-500';
                    break;
                case 42:
                    networkName = 'Kovan Testnet';
                    networkClass = 'text-green-500';
                    break;
                default:
                    networkName = 'Unknown Network';
                    networkClass = 'text-gray-500';
            }
            
            const networkStatus = document.getElementById('networkStatus');
            networkStatus.textContent = networkName;
            networkStatus.className = `text-sm md:inline-block ${networkClass}`;
            networkStatus.classList.remove('hidden');
        }

        function showApp() {
            if (!connected) {
                alert('Please connect your wallet first to access the app');
                return;
            }
            
            document.getElementById('landing').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
        }

        function showCreateChannelModal(type) {
            if (!connected) {
                alert('Please connect your wallet to create channels');
                return;
            }
            
            document.getElementById('channelName').value = '';
            document.getElementById('channelTypeHidden').value = type;
            document.getElementById('modalTitle').textContent = `Create New ${type === 'text' ? 'Text' : 'Voice'} Channel`;
            document.getElementById('createChannelModal').classList.remove('hidden');
        }

        function hideCreateChannelModal() {
            document.getElementById('createChannelModal').classList.add('hidden');
        }

        async function createChannel() {
            const channelName = document.getElementById('channelName').value.trim();
            const channelType = document.getElementById('channelTypeHidden').value;
            
            if (!channelName) {
                alert('Please enter a channel name');
                return;
            }
            
            if (!currentAccount) {
                alert('Wallet not connected! Please connect your wallet first.');
                return;
            }
            
            // Hide the create channel modal
            hideCreateChannelModal();
            
            // Show the transaction modal
            showTransactionModal('pending');
            
            try {
                // Send a test transaction to simulate channel creation
                const txParams = {
                    from: currentAccount,
                    to: currentAccount, // Send to self
                    value: web3.utils.toWei('0.001', 'ether'), // Small amount for test
                    gas: 21000
                };
                
                const receipt = await web3.eth.sendTransaction(txParams);
                
                // Add channel to the appropriate list
                addChannelToList(channelName, channelType);
                
                // Initialize the channel message array if it's a text channel
                if (channelType === 'text' && !messages[channelName]) {
                    messages[channelName] = [
                        { sender: 'System', content: `Welcome to the #${channelName} channel!`, timestamp: new Date().toISOString() }
                    ];
                }
                
                // Show success modal
                showTransactionModal('success');
                
                // Load the newly created channel
                setTimeout(() => {
                    closeTransactionModal();
                    loadChannel(channelName, channelType);
                }, 1500);
                
            } catch (error) {
                console.error("Error creating channel:", error);
                showTransactionModal('error', error.message);
            }
        }
        
        function showTransactionModal(state, errorMsg = '') {
            const modal = document.getElementById('transactionModal');
            const pendingEl = document.getElementById('txPending');
            const successEl = document.getElementById('txSuccess');
            const errorEl = document.getElementById('txError');
            
            modal.classList.remove('hidden');
            pendingEl.classList.add('hidden');
            successEl.classList.add('hidden');
            errorEl.classList.add('hidden');
            
            if (state === 'pending') {
                pendingEl.classList.remove('hidden');
            } else if (state === 'success') {
                successEl.classList.remove('hidden');
            } else if (state === 'error') {
                errorEl.classList.remove('hidden');
                document.getElementById('txErrorMessage').textContent = errorMsg || 'There was an error processing your transaction.';
            }
        }
        
        function closeTransactionModal() {
            document.getElementById('transactionModal').classList.add('hidden');
        }
        
        function addChannelToList(channelName, channelType) {
            // Create the channel element
            const channelElement = document.createElement('div');
            channelElement.className = 'channel flex items-center gap-2 p-2 rounded cursor-pointer mb-1';
            channelElement.onclick = function() { loadChannel(channelName, channelType); };
            channelElement.innerHTML = `
                <i class="bi bi-${channelType === 'text' ? 'hash' : 'broadcast'} text-gray-400"></i>
                <span>${channelName}</span>
            `;
            
            // Add to desktop list
            const listContainerId = channelType === 'text' ? 'textChannelList' : 'voiceChannelList';
            document.getElementById(listContainerId).appendChild(channelElement.cloneNode(true));
            
            // Add to mobile list
            const mobileListContainerId = channelType === 'text' ? 'mobileTextChannelList' : 'mobileVoiceChannelList';
            const mobileChannelElement = channelElement.cloneNode(true);
            mobileChannelElement.onclick = function() { 
                loadChannel(channelName, channelType);
                toggleMobileNav();
            };
            document.getElementById(mobileListContainerId).appendChild(mobileChannelElement);
        }
        
        function loadChannel(channelName, channelType) {
            currentChannelName = channelName;
            currentChannelType = channelType;
            
            // Update channel header
            const channelHeader = document.getElementById('channelHeader');
            const icon = channelType === 'text' ? 'hash' : 'broadcast';
            channelHeader.innerHTML = `
                <i class="bi bi-${icon} text-gray-400 text-xl mr-2"></i>
                <h3 id="currentChannelName" class="font-bold">${channelName}</h3>
            `;
            channelHeader.classList.remove('hidden');
            
            // Clear active channel classes
            document.querySelectorAll('.channel').forEach(channel => {
                channel.classList.remove('channel-active');
            });
            
            // Add active class to current channel
            document.querySelectorAll('.channel').forEach(channel => {
                if (channel.querySelector('span').textContent === channelName) {
                    channel.classList.add('channel-active');
                }
            });
            
            // Update content area
            if (channelType === 'text') {
                loadTextChannel(channelName);
            } else {
                loadVoiceChannel(channelName);
            }
        }
        
        function loadTextChannel(channelName) {
            const channelContent = document.getElementById('channelContent');
            const messageInputContainer = document.getElementById('messageInputContainer');
            
            // Show message input for text channels
            messageInputContainer.classList.remove('hidden');
            document.getElementById('messageInput').placeholder = `Message #${channelName}`;
            
            // Display message history
            channelContent.innerHTML = '';
            
            const messageList = document.createElement('div');
            messageList.className = 'space-y-4';
            
            if (messages[channelName]) {
                messages[channelName].forEach(msg => {
                    const messageEl = document.createElement('div');
                    messageEl.className = 'message p-2 rounded hover:bg-[#32353b]';
                    
                    const isSystem = msg.sender === 'System';
                    
                    messageEl.innerHTML = `
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 rounded-full ${isSystem ? 'bg-[#5865F2]' : 'bg-[#3ba55c]'} flex items-center justify-center flex-shrink-0">
                                <i class="bi bi-${isSystem ? 'discord' : 'person-fill'} ${isSystem ? '' : 'text-lg'}"></i>
                            </div>
                            <div>
                                <div class="flex items-baseline gap-2">
                                    <span class="font-medium">${msg.sender}</span>
                                    <span class="text-xs text-gray-400">${formatTimestamp(msg.timestamp)}</span>
                                </div>
                                <div class="mt-1">${msg.content}</div>
                            </div>
                        </div>
                    `;
                    
                    messageList.appendChild(messageEl);
                });
            }
            
            channelContent.appendChild(messageList);
            
            // Scroll to bottom of messages
            channelContent.scrollTop = channelContent.scrollHeight;
        }
        
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (content && currentChannelName) {
                // Create message object
                const message = {
                    sender: currentAccount ? `${currentAccount.substring(0, 6)}...${currentAccount.substring(currentAccount.length - 4)}` : 'Anonymous',
                    content: content,
                    timestamp: new Date().toISOString()
                };
                
                // Add to message store
                if (!messages[currentChannelName]) {
                    messages[currentChannelName] = [];
                }
                messages[currentChannelName].push(message);
                
                // Reload channel to show new message
                loadTextChannel(currentChannelName);
                
                // Clear input
                messageInput.value = '';
            }
        }
        
        async function loadVoiceChannel(channelName) {
            const channelContent = document.getElementById('channelContent');
            const messageInputContainer = document.getElementById('messageInputContainer');
            
            // Hide message input for voice channels
            messageInputContainer.classList.add('hidden');
            
            // Update voice channel interface
            channelContent.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full">
                    <div class="bg-[#2f3136] p-6 rounded-lg shadow-lg max-w-md w-full mb-6">
                        <h3 class="font-bold text-xl mb-4 flex items-center gap-2">
                            <i class="bi bi-broadcast text-[#5865F2]"></i> ${channelName}
                        </h3>
                        
                        <div class="avatars-holder flex justify-center mb-6">
                            <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center">
                                <i class="bi bi-person-fill text-2xl"></i>
                            </div>
                        </div>
                        
                        <p class="text-center text-gray-400 mb-6">Click the button below to join the voice channel.</p>
                        
                        <button id="joinVoiceBtn" onclick="joinVoiceChannel('${channelName}')" class="bg-[#5865F2] w-full py-3 rounded-md hover:bg-[#4752C4] transition flex items-center justify-center gap-2">
                            <i class="bi bi-headset"></i>
                            Join Voice Channel
                        </button>
                    </div>
                </div>
            `;
        }
        
        async function joinVoiceChannel(channelName) {
            try {
                if (voiceConnected) {
                    return;
                }
                
                // Request microphone access
                mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                voiceConnected = true;
                
                // Show voice chat modal
                document.getElementById('voiceChannelTitle').textContent = channelName;
                document.getElementById('voiceChatModal').classList.remove('hidden');
                
                // Set up mute button
                const muteBtn = document.getElementById('muteBtn');
                let muted = false;
                
                muteBtn.onclick = () => {
                    muted = !muted;
                    mediaStream.getAudioTracks()[0].enabled = !muted;
                    
                    if (muted) {
                        muteBtn.innerHTML = '<i class="bi bi-mic-mute-fill text-lg"></i>';
                        muteBtn.classList.add('bg-red-500');
                        muteBtn.classList.remove('bg-[#4f545c]');
                    } else {
                        muteBtn.innerHTML = '<i class="bi bi-mic-fill text-lg"></i>';
                        muteBtn.classList.remove('bg-red-500');
                        muteBtn.classList.add('bg-[#4f545c]');
                    }
                };
                
                // Update UI to show voice connected
                const joinVoiceBtn = document.getElementById('joinVoiceBtn');
                joinVoiceBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Connected';
                joinVoiceBtn.classList.remove('bg-[#5865F2]');
                joinVoiceBtn.classList.add('bg-green-500');
                
                // Add audio visualization effect
                const avatarHolder = document.querySelector('.avatars-holder');
                
                // Simulate voice activity with animation
                const voiceActivityInterval = setInterval(() => {
                    if (!voiceConnected) {
                        clearInterval(voiceActivityInterval);
                        return;
                    }
                    
                    // Add a small pulse animation to simulate voice activity
                    avatarHolder.classList.add('scale-110');
                    setTimeout(() => {
                        avatarHolder.classList.remove('scale-110');
                    }, 200);
                }, 2000);
            } catch (error) {
                console.error("Error accessing microphone:", error);
                alert("Failed to access microphone. Please check your permissions.");
            }
        }
        
        function leaveVoiceChannel() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            voiceConnected = false;
            document.getElementById('voiceChatModal').classList.add('hidden');
            
            // Update UI to show disconnected state
            if (document.getElementById('joinVoiceBtn')) {
                const joinVoiceBtn = document.getElementById('joinVoiceBtn');
                joinVoiceBtn.innerHTML = '<i class="bi bi-headset"></i> Join Voice Channel';
                joinVoiceBtn.classList.add('bg-[#5865F2]');
                joinVoiceBtn.classList.remove('bg-green-500');
            }
        }
    </script>
<script>document.body.addEventListener('wheel', e => { if (!e.ctrlKey) return; e.preventDefault(); return }, { passive: false })</script>
	</body>
</html>